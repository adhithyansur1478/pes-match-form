<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PES Esports Match Registration</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div id="form-container" class="form-container" style="display: none;">
            <h1>PES Match Registration</h1>
            <form id="matchForm">
                <label for="pesid">PES ID:</label>
                <input type="text" id="pesid" name="pesid" required>

                <label for="phone">Phone Number:</label>
                <input type="text" id="phone" name="phone" required>

                <label for="roomnumber">Room Number:</label>
                <input type="number" id="roomnumber" name="roomnumber" required>

                <button type="submit">Submit</button>
            </form>
        </div>

        <div id="message" style="display: none; color: red; font-size: 18px;"></div>
    </div>

    <footer class="small-footer">
        <ul>
            <li><a href="contact.html">Contact Us</a></li>
            <li><a href="terms.html">Terms and Conditions</a></li>
            <li><a href="refund.html">Refund Policy</a></li>
        </ul>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getDatabase, ref, get, set, update } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB0XNxFP7npEaXDhhbynAl-4fcFXBSKlW4",
            authDomain: "betproject-d69cd.firebaseapp.com",
            databaseURL: "https://betproject-d69cd-default-rtdb.firebaseio.com",
            projectId: "betproject-d69cd",
            storageBucket: "betproject-d69cd.firebasestorage.app",
            messagingSenderId: "991851561202",
            appId: "1:991851561202:web:56244535a998336ce4906b",
            measurementId: "G-3FHL5483T4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Get uniqueId from URL
        const urlParams = new URLSearchParams(window.location.search);
        const uniqueId = urlParams.get("match_id");
        console.log("Extracted uniqueId:", uniqueId); // Debugging log
         
        let matchRef, matchAcceptRef;

        if (uniqueId) {
            const matchRef = ref(db, "responses/" + uniqueId);
            const matchAcceptRef = ref(db, "match_accept/" + uniqueId);

            // Check Match Status
            get(matchRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const matchData = snapshot.val();
                    console.log("Match data:", matchData); // Debugging log

                    if (matchData.status === "open") {
                        document.getElementById("form-container").style.display = "block";
                    } else {
                        document.getElementById("message").innerText = "This match is already taken.";
                        document.getElementById("message").style.display = "block";
                    }
                } else {
                    console.warn("Match not found in database");
                    document.getElementById("message").innerText = "Invalid match link.";
                    document.getElementById("message").style.display = "block";
                }
            }).catch((error) => {
                console.error("Error fetching match data:", error);
            });
        } else {
            console.warn("No uniqueId found in URL");
            document.getElementById("message").innerText = "Invalid match link.";
            document.getElementById("message").style.display = "block";
        }

        // Handle Form Submission
        document.getElementById("matchForm").addEventListener("submit", function (event) {
            event.preventDefault();

            const pesId = document.getElementById("pesid").value;
            const phone = document.getElementById("phone").value;
            const roomNumber = document.getElementById("roomnumber").value;

            if (uniqueId) {
                get(matchRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const matchData = snapshot.val();

                        if (matchData.status === "open") {
                            // Update Firebase: Close Match
                            update(matchRef, { status: "closed" });

                            // Store Form Data in match_accept
                            set(matchAcceptRef, {
                                pesid: pesId,
                                phone: phone,
                                room_number: roomNumber,
                                timestamp: new Date().toISOString()
                            }).then(() => {
                                alert("Match successfully joined!");
                                window.location.href = "match_full.html";
                            });
                        } else {
                            alert("This match is already taken.");
                        }
                    } else {
                        alert("Match not found.");
                    }
                }).catch((error) => {
                    console.error("Error submitting form:", error);
                });
            }
        });
    </script>
</body>
</html>
